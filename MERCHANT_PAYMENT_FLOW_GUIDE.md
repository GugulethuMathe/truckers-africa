# Merchant Payment Flow - User Guide

## What Merchants Will See

### 1. Dashboard View (Unpaid Subscription)

When a merchant logs in with an unpaid subscription, they will see:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”’ Payment Required to Activate Your Subscription              â”‚
â”‚                                                                 â”‚
â”‚ Your subscription is pending payment. Please complete your     â”‚
â”‚ payment to activate your account and access all premium        â”‚
â”‚ features. You will be redirected to PayFast to complete the    â”‚
â”‚ payment securely.                                              â”‚
â”‚                                                                 â”‚
â”‚ [ğŸ’³ Complete Payment Now â†’]                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Key Features**:
- Red border and background (high visibility)
- Clear explanation of what's needed
- Large, prominent payment button
- Credit card icon for visual clarity

### 2. Subscription Management Page (Unpaid)

When merchants navigate to `/merchant/subscription`:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”’ Payment Required to Activate Your Subscription              â”‚
â”‚                                                                 â”‚
â”‚ Your subscription is pending payment. Please complete your     â”‚
â”‚ payment to activate your account and access all premium        â”‚
â”‚ features.                                                      â”‚
â”‚                                                                 â”‚
â”‚ [ğŸ’³ Complete Payment Now]                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Current Subscription                                            â”‚
â”‚                                                                 â”‚
â”‚ Professional Plan                                               â”‚
â”‚ Full access to all features                                    â”‚
â”‚ $29.99/month                                                   â”‚
â”‚                                                                 â”‚
â”‚ Status: [Payment Required]                                     â”‚
â”‚                                                                 â”‚
â”‚ [Complete Payment]  [Change Plan]                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. When Trying to Access Paid Features

If merchant tries to access listings, orders, or other paid features:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš ï¸ Access Restricted                                            â”‚
â”‚                                                                 â”‚
â”‚ Payment required! Please complete your payment to activate     â”‚
â”‚ your subscription and access premium features. Click           â”‚
â”‚ "Complete Payment" below to proceed to PayFast.               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â†’ Redirected to /merchant/subscription page
```

### 4. Payment Flow

```
Step 1: Merchant Dashboard
   â†“
   [Complete Payment Now] button clicked
   â†“
Step 2: Subscription::processPayment()
   â†“
Step 3: Payment::process($planId)
   â†“
Step 4: PayFast Payment Page
   â”œâ”€ Merchant enters payment details
   â”œâ”€ Confirms payment
   â””â”€ PayFast processes payment
   â†“
Step 5: PayFast ITN (Instant Transaction Notification)
   â”œâ”€ Payment::notify() receives confirmation
   â”œâ”€ Updates subscription status to 'active'
   â””â”€ Sets billing period dates
   â†“
Step 6: Merchant Redirected to Success Page
   â†“
Step 7: Full Access Granted âœ…
```

## Subscription Statuses Explained

### For Merchants:

| Status | What It Means | What Merchant Sees | Action Required |
|--------|---------------|-------------------|-----------------|
| **new** | Plan selected, payment pending | "Payment Required" badge | Complete payment via PayFast |
| **trial_pending** | Trial plan selected, payment method needed | "Payment Setup Required" badge | Add payment method (no charge yet) |
| **trial** | Free trial active | "X-Day Free Trial (Y days left)" | None - enjoy trial period |
| **active** | Paid and active | "Active" badge | None - all features available |
| **past_due** | Billing period ended | "Past Due" badge | Renew subscription |
| **expired** | Trial ended without payment | "Expired" badge | Subscribe to continue |
| **cancelled** | Manually cancelled | "Cancelled" badge | Resubscribe if needed |

## Button Behavior by Status

### Dashboard Payment Button:
- **new**: "Complete Payment Now â†’" (redirects to PayFast)
- **trial_pending**: "Complete Payment Setup â†’" (redirects to PayFast)
- **trial**: No payment button (trial active)
- **active**: No payment button (subscription active)
- **past_due**: "Renew Subscription" (redirects to renewal payment)
- **expired**: "Subscribe Now" (redirects to plan selection)

### Subscription Page Buttons:
- **new/trial_pending**: 
  - Primary: "Complete Payment" (green, prominent)
  - Secondary: "Change Plan" (gray)
  - No "Cancel Subscription" button
- **active/trial**:
  - Primary: "Change Plan" (blue)
  - Secondary: "Cancel Subscription" (red)
- **past_due**:
  - Primary: "Renew Subscription" (green)

## Feature Access Control

### Blocked Features (Unpaid Subscriptions):
- âŒ Creating/editing listings
- âŒ Managing orders
- âŒ Adding branch locations
- âŒ Viewing analytics
- âŒ Accessing merchant tools

### Allowed Features (Unpaid Subscriptions):
- âœ… View dashboard (with payment alert)
- âœ… View/edit profile
- âœ… View subscription page
- âœ… Change plan selection
- âœ… Complete payment
- âœ… Logout

## Plan Change Behavior

### If Subscription is Unpaid (new/trial_pending):
1. Merchant can change plan at any time
2. System updates subscription with new plan_id
3. Redirects to PayFast with new plan amount
4. No prorata calculation (no previous payment)

### If Subscription is Active:
1. System calculates prorata amount
2. Shows breakdown preview
3. If upgrade: Redirects to PayFast for difference
4. If downgrade: Applies immediately with credit

## Error Messages

### When Blocked by SubscriptionFilter:
```
Payment required! Please complete your payment to activate your 
subscription and access premium features. Click "Complete Payment" 
below to proceed to PayFast.
```

### When No Plan Selected:
```
No plan selected. Please choose a plan first.
```

### When Payment Fails:
```
Payment failed. Please try again or contact support.
```

## Support Information

If merchants encounter issues:
- Phone/WhatsApp: +27687781223
- Email: support@truckersafrica.com
- Payment issues are handled by PayFast support

